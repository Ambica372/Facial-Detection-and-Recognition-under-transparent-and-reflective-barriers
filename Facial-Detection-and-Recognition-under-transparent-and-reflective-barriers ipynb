!pip install insightface onnxruntime opencv-python matplotlib scikit-learn
import cv2
import numpy as np
import matplotlib.pyplot as plt

from insightface.app import FaceAnalysis
from sklearn.metrics.pairwise import cosine_similarity
def reflection_aware_preprocessing(img_bgr):
    # Convert BGR → RGB
    img_rgb = cv2.cvtColor(img_bgr, cv2.COLOR_BGR2RGB)

    # Sharpening kernel
    kernel = np.array([
        [-1, -1, -1],
        [-1,  9, -1],
        [-1, -1, -1]
    ])

    sharpened = cv2.filter2D(img_rgb, -1, kernel)

    # Weighted fusion (controls noise)
    enhanced = cv2.addWeighted(
        img_rgb, 0.7,
        sharpened, 0.3,
        0
    )

    return enhanced
app = FaceAnalysis(
    name="buffalo_s",   # includes detector + ArcFace
    providers=["CPUExecutionProvider"]
)

app.prepare(ctx_id=0, det_thresh=0.3)  # lower threshold for faint faces
img1_path = "person_normal.jpg"      # normal image
img2_path = "person_behind_glass.jpg" # behind glass / reflection

img1 = cv2.imread(img1_path)
img2 = cv2.imread(img2_path)

assert img1 is not None, "Image 1 not found"
assert img2 is not None, "Image 2 not found"
img1_proc = reflection_aware_preprocessing(img1)
img2_proc = reflection_aware_preprocessing(img2)
faces1 = app.get(img1_proc)
faces2 = app.get(img2_proc)

if len(faces1) == 0 or len(faces2) == 0:
    raise Exception("Face not detected in one of the images")

# Take first detected face
emb1 = faces1[0].embedding.reshape(1, -1)
emb2 = faces2[0].embedding.reshape(1, -1)
similarity = cosine_similarity(emb1, emb2)[0][0]

print("Cosine Similarity:", similarity)

threshold = 0.5  # typical verification threshold

if similarity > threshold:
    print("✅ Same person")
else:
    print("❌ Different person")
